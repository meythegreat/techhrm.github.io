<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mobile Attendance</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <style>
        .watermark-fixed {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 80vw; height: 80vw;
            background-image: url('assets/logo.png'); opacity: 0.05; z-index: -1; pointer-events: none; background-size: contain; background-repeat: no-repeat;
        }
        #reader { width: 100%; border-radius: 12px; overflow: hidden; background: black; border: 4px solid #facc15; }
        #reader video { object-fit: cover; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans pb-24 select-none overflow-x-hidden">

    <div class="watermark-fixed"></div>
    <header class="fixed top-0 w-full bg-[#1e3a8a] text-white shadow-md z-30">
        <div class="flex justify-between items-center p-4">
            <div class="flex items-center gap-2">
                <img src="assets/logo.png" class="w-10 h-10 rounded-full bg-white p-0.5">
                <h1 class="font-bold text-lg">TechHRM</h1>
            </div>
            <button id="menuBtn" class="text-3xl focus:outline-none"><i class='bx bx-menu'></i></button>
        </div>
    </header>
    <div class="h-20"></div>

    <main class="px-4">
        <h2 class="text-2xl font-bold text-blue-900 mb-4 pl-3 border-l-4 border-yellow-400">Attendance</h2>

        <div class="bg-white rounded-2xl shadow-lg border border-gray-200 p-5 mb-6">
            <div class="text-center border-b border-gray-100 pb-3 mb-4">
                <span class="text-gray-400 text-xs uppercase tracking-widest">Today's Date</span>
                <p id="displayDate" class="text-lg font-bold text-gray-800 mt-1">...</p>
            </div>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="text-center p-3 bg-green-50 rounded-xl">
                    <p class="text-xs text-green-600 font-bold uppercase">Time In</p>
                    <p id="displayTimeIn" class="text-xl font-bold text-green-700">--:--</p>
                </div>
                <div class="text-center p-3 bg-blue-50 rounded-xl">
                    <p class="text-xs text-blue-600 font-bold uppercase">Time Out</p>
                    <p id="displayTimeOut" class="text-xl font-bold text-blue-700">--:--</p>
                </div>
            </div>
            <div class="flex justify-between items-center text-sm px-2">
                <span class="text-gray-500">Status</span>
                <span id="displayStatus" class="font-bold text-gray-400 uppercase">Pending</span>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-lg border border-gray-200 p-6 transition-all" id="selectionCard">
            <label class="block text-blue-900 font-bold text-sm mb-2 text-center uppercase tracking-wide">Select Activity Mode</label>
            <div class="relative mb-6">
                <select id="activityMode" class="w-full p-4 text-lg border-2 border-blue-200 rounded-xl bg-gray-50 font-bold focus:border-yellow-400 outline-none appearance-none text-gray-700">
                    <option value="" disabled selected>Tap to Select</option>
                    <optgroup label="REGULAR DUTIES (Passcode)">
                        <option value="Normal/Clerical Duty">Clerical Duty</option>
                        <option value="Janitorial Duty">Janitorial Duty</option>
                        <option value="Request Duty">Request Duty</option>
                        <option value="Daily Cleaning">Daily Cleaning</option>
                    </optgroup>
                    <optgroup label="EVENTS (QR Scan)">
                        <option value="General Meeting">General Meeting</option>
                        <option value="General Cleaning">General Cleaning</option>
                    </optgroup>
                </select>
                <div class="absolute right-4 top-4 pointer-events-none text-blue-600"><i class='bx bx-chevron-down text-2xl'></i></div>
            </div>

            <div id="methodContainer" class="hidden animate-[fadeIn_0.3s_ease-out]">
                <button id="btnEnterCode" class="hidden w-full bg-blue-600 text-white font-bold py-4 rounded-xl shadow-md active:scale-95 mb-4 flex items-center justify-center gap-2">
                    <i class='bx bx-key text-xl'></i> ENTER PASSCODE
                </button>
                <button id="btnScan" class="hidden w-full bg-yellow-400 text-blue-900 font-bold py-4 rounded-xl shadow-md active:scale-95 flex items-center justify-center gap-2">
                    <i class='bx bx-qr-scan text-xl'></i> SCAN KIOSK QR
                </button>
            </div>
        </div>
    </main>
    
    <div id="codeModal" class="fixed inset-0 bg-blue-900/90 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl p-6">
            <h3 class="text-xl font-bold text-blue-900 text-center mb-4">Enter Passcode</h3>
            <form id="codeForm"><input type="text" id="codeInput" class="w-full text-center text-3xl font-mono border-2 border-gray-300 rounded-xl py-3 mb-6 outline-none uppercase tracking-widest" placeholder="123456" maxlength="6" required><div class="grid grid-cols-2 gap-3"><button type="button" onclick="document.getElementById('codeModal').classList.add('hidden')" class="py-3 bg-gray-100 rounded-xl font-bold text-gray-600">Cancel</button><button type="submit" class="py-3 bg-blue-600 text-white rounded-xl font-bold shadow-md">Submit</button></div></form>
        </div>
    </div>

    <div id="scanModal" class="fixed inset-0 bg-black/95 z-[60] hidden flex flex-col items-center justify-center p-4">
        <div id="reader" class="mb-6 shadow-2xl"></div>
        <p class="text-white text-lg font-bold text-center mb-2 animate-pulse">Scanning...</p>
        <p class="text-gray-400 text-sm text-center mb-8">Point at Desktop Screen</p>
        <button id="cancelScan" class="px-10 py-4 border border-white/40 rounded-full text-white font-bold bg-white/10 backdrop-blur-sm">Cancel</button>
    </div>

    <div id="successModal" class="fixed inset-0 bg-blue-900/90 z-[70] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl p-8 text-center"><div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4"><i class='bx bx-check text-4xl text-green-600'></i></div><h3 class="text-2xl font-bold text-gray-800 mb-2">Success!</h3><p id="successMessage" class="text-gray-600 mb-6">Action completed.</p><button onclick="document.getElementById('successModal').classList.add('hidden')" class="w-full py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg">Continue</button></div>
    </div>
    
    <div id="sidebarBackdrop" class="fixed inset-0 bg-black/60 z-40 hidden transition-opacity duration-300 opacity-0"></div>
    <aside id="mobileSidebar" class="fixed inset-y-0 right-0 w-[65%] bg-white z-50 transform translate-x-full transition-transform duration-300 ease-in-out shadow-2xl flex flex-col font-sans">
         <div class="h-32 bg-gradient-to-b from-[#526DFE] to-[#1e3a8a] relative"><div class="absolute -bottom-12 left-1/2 transform -translate-x-1/2"><div class="w-24 h-24 bg-gray-200 rounded-full border-4 border-white shadow-lg overflow-hidden flex items-center justify-center"><i class='bx bxs-user text-5xl text-gray-400'></i></div></div></div><div class="mt-14 text-center px-4"><h3 class="font-black text-gray-800 uppercase leading-tight text-lg mb-1">Yvan Dale Ocbena Lastimoso</h3><button onclick="if(confirm('Sign out?')) location.href='mobile-login.html'" class="text-gray-400 text-sm hover:text-red-500 underline">Sign Out</button></div><nav class="flex-1 px-6 py-8 space-y-6"><a href="mobile-dashboard.html" class="flex items-center text-lg font-medium text-gray-600 hover:text-blue-600 px-4 py-2 rounded-xl transition-colors">Dashboard</a><a href="mobile-attendance.html" class="flex items-center text-lg font-bold text-gray-800 bg-white shadow-[0_3px_10px_rgb(0,0,0,0.1)] px-4 py-3 rounded-xl border-l-4 border-blue-600">Attendance</a><a href="mobile-assessment.html" class="flex items-center text-lg font-medium text-gray-600 hover:text-blue-600 px-4 py-2 rounded-xl transition-colors">Assessment</a><a href="mobile-schedule.html" class="flex items-center text-lg font-medium text-gray-600 hover:text-blue-600 px-4 py-2 rounded-xl transition-colors">Schedule</a><a href="mobile-worklog.html" class="flex items-center text-lg font-medium text-gray-600 hover:text-blue-600 px-4 py-2 rounded-xl transition-colors">Work Log</a></nav>
    </aside>

    <script>
        const menuBtn = document.getElementById('menuBtn');
        const sidebar = document.getElementById('mobileSidebar');
        const backdrop = document.getElementById('sidebarBackdrop');
        menuBtn.addEventListener('click', () => { backdrop.classList.remove('hidden'); setTimeout(() => backdrop.classList.remove('opacity-0'), 10); sidebar.classList.remove('translate-x-full'); });
        backdrop.addEventListener('click', () => { backdrop.classList.add('opacity-0'); sidebar.classList.add('translate-x-full'); setTimeout(() => backdrop.classList.add('hidden'), 300); });

        const today = new Date(); document.getElementById('displayDate').innerText = today.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        
        let currentState = 'logged_out', timeInDate = null, selectedMode = "";
        let html5QrcodeScanner = null;

        const activitySelect = document.getElementById('activityMode'), container = document.getElementById('methodContainer');
        const btnCode = document.getElementById('btnEnterCode'), btnScan = document.getElementById('btnScan');
        const elTimeIn = document.getElementById('displayTimeIn'), elTimeOut = document.getElementById('displayTimeOut'), elStatus = document.getElementById('displayStatus');
        const scanModal = document.getElementById('scanModal'), cancelScan = document.getElementById('cancelScan');

        activitySelect.addEventListener('change', function() {
            selectedMode = this.value; 
            container.classList.remove('hidden');
            
            // LOGIC MATCHING DESKTOP: Only Cleaning/Meetings use Scan
            const qrDuties = ["General Cleaning", "General Meeting"];
            if (qrDuties.includes(selectedMode)) {
                btnScan.classList.remove('hidden');
                btnCode.classList.add('hidden');
            } else {
                btnCode.classList.remove('hidden');
                btnScan.classList.add('hidden');
            }
        });

        // Passcode
        btnCode.onclick = () => { if(currentState === 'completed') { alert("Done."); return; } document.getElementById('codeInput').value = ''; document.getElementById('codeModal').classList.remove('hidden'); };
        document.getElementById('codeForm').onsubmit = (e) => { e.preventDefault(); document.getElementById('codeModal').classList.add('hidden'); performAction("Manual Code"); };
        
        // Scan
        btnScan.onclick = () => { if(currentState === 'completed') { alert("Done."); return; } startScanner(); };
        cancelScan.onclick = () => { stopScanner(); };

        function startScanner() {
            scanModal.classList.remove('hidden');
            if (!html5QrcodeScanner) {
                html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: {width: 250, height: 250} }, false);
            }
            html5QrcodeScanner.render(onScanSuccess, onScanFailure);
        }

        function stopScanner() {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.clear().then(() => { scanModal.classList.add('hidden'); }).catch(err => { console.error(err); scanModal.classList.add('hidden'); });
            } else { scanModal.classList.add('hidden'); }
        }

        function onScanSuccess(decodedText) {
            stopScanner();
            performAction("QR: " + selectedMode);
        }

        function onScanFailure(error) { }

        function performAction(method) {
            const now = new Date(); const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            if (currentState === 'logged_out') {
                currentState = 'logged_in'; timeInDate = now;
                elTimeIn.innerText = timeString; elTimeIn.classList.add('text-green-600'); elStatus.innerText = "Active"; elStatus.className = "font-bold text-green-600 uppercase";
                document.getElementById('successMessage').innerHTML = `Timed IN for<br><strong class="text-blue-600">${selectedMode}</strong><br>at ${timeString}`;
                document.getElementById('successModal').classList.remove('hidden');
            } else if (currentState === 'logged_in') {
                currentState = 'completed'; elTimeOut.innerText = timeString; elTimeOut.classList.add('text-blue-600');
                const diffHrs = ((now - timeInDate) / (1000 * 60 * 60)).toFixed(2);
                elStatus.innerText = "Completed"; elStatus.className = "font-bold text-blue-600 uppercase";
                document.getElementById('successMessage').innerHTML = `Timed OUT from<br><strong class="text-blue-600">${selectedMode}</strong><br>Total: ${diffHrs} hrs`;
                document.getElementById('successModal').classList.remove('hidden');
            }
        }

        // Add this inside your <script> tag in mobile-attendance.html

        function onScanSuccess(decodedText) {
            // 1. Play Beep Sound
            const beep = new Audio('https://www.soundjay.com/buttons/beep-01a.mp3');
            beep.play();

            // 2. Vibrate Phone (200ms) - Works on Android
            if (navigator.vibrate) navigator.vibrate(200);

            // 3. Stop Camera
            stopScanner();
            
            // 4. Parse Data & Execute
            let displayText = selectedMode;
            try {
                const data = JSON.parse(decodedText);
                if(data.type) displayText = data.type;
            } catch(e) {}

            performAction(displayText); 
        }
    </script>
</body>
</html>